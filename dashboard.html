<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSOG Franchise Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="https://i.postimg.cc/kMZ1jTww/Untitled-design-4-removebg-preview.png">
    <style>
        /* Additional dashboard styles */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #7f8c8d;
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 20px;
            color: #bdc3c7;
        }
        
        .auth-error {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #e74c3c;
            color: white;
            padding: 20px;
            text-align: center;
            z-index: 10000;
        }
        
        .auth-error a {
            color: white;
            text-decoration: underline;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <!-- Authentication Error Banner (hidden by default) -->
    <div id="authError" class="auth-error" style="display: none;">
        <i class="fas fa-exclamation-triangle"></i>
        You need to login to access the dashboard.
        <a href="index.html">Click here to login</a>
    </div>

    <!-- Header -->
    <header class="dashboard-header">
        <div class="header-left">
            <img src="https://i.postimg.cc/kMZ1jTww/Untitled-design-4-removebg-preview.png" alt="DSOG Logo" height="35">
            <span class="brand-name">DSOG Franchise Portal</span>
        </div>
        
        <div class="user-info">
            <div class="user-avatar" id="userAvatar">FO</div>
            <div class="user-details">
                <div class="user-name" id="userName">Franchise Owner</div>
                <div class="user-role" id="userRole">Loading...</div>
            </div>
            <button class="btn btn-outline" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="dashboard-container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="sidebar-nav">
                <ul>
                    <li>
                        <a href="#" class="active" onclick="showSection('dashboard')">
                            <i class="fas fa-home"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" onclick="showSection('products')">
                            <i class="fas fa-shopping-cart"></i>
                            <span>Product Ordering</span>
                            <span class="badge" id="productsBadge">0</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" onclick="showSection('orders')">
                            <i class="fas fa-clipboard-list"></i>
                            <span>My Orders</span>
                            <span class="badge badge-warning" id="pendingOrdersBadge">0</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" onclick="showSection('inventory')">
                            <i class="fas fa-boxes"></i>
                            <span>Inventory</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" onclick="showSection('resources')">
                            <i class="fas fa-file-alt"></i>
                            <span>Marketing Materials</span>
                            <span class="badge" id="materialsBadge">0</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" onclick="showSection('updates')">
                            <i class="fas fa-bullhorn"></i>
                            <span>Operational Updates</span>
                            <span class="badge badge-danger" id="updatesBadge">0</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" onclick="showSection('delivery')">
                            <i class="fas fa-truck"></i>
                            <span>Delivery Partners</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" onclick="showSection('support')">
                            <i class="fas fa-headset"></i>
                            <span>Support</span>
                        </a>
                    </li>
                </ul>
                
                <div class="sidebar-footer">
                    <div class="franchise-info">
                        <div class="franchise-code" id="franchiseCode">FR-000</div>
                        <small>Your Franchise Code</small>
                    </div>
                    <div class="help-section">
                        <a href="tel:0733737983" class="help-link">
                            <i class="fas fa-phone"></i> 0733 737 983
                        </a>
                        <a href="mailto:office.dsog@gmail.com" class="help-link">
                            <i class="fas fa-envelope"></i> Email Support
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Welcome Section -->
            <div class="card welcome-card">
                <div class="welcome-content">
                    <h1>Welcome back, <span id="welcomeName">Partner</span>!</h1>
                    <p>Your DSOG online fashion franchise dashboard. Manage orders, access marketing materials, and grow your business.</p>
                    <div class="quick-stats">
                        <div class="quick-stat">
                            <i class="fas fa-shopping-cart"></i>
                            <div>
                                <div class="stat-number" id="todayOrders">0</div>
                                <div class="stat-label">Today's Orders</div>
                            </div>
                        </div>
                        <div class="quick-stat">
                            <i class="fas fa-chart-line"></i>
                            <div>
                                <div class="stat-number" id="monthRevenue">KES 0</div>
                                <div class="stat-label">This Month</div>
                            </div>
                        </div>
                        <div class="quick-stat">
                            <i class="fas fa-box"></i>
                            <div>
                                <div class="stat-number" id="availableProducts">0</div>
                                <div class="stat-label">Available Products</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="welcome-image">
                    <img src="https://i.postimg.cc/c4zFGFxn/COLLECTIONS-removebg-preview.png" alt="HOG Creations">
                </div>
            </div>

            <!-- Dashboard Section -->
            <div id="dashboardSection" class="content-section active">
                <div class="section-header">
                    <h2><i class="fas fa-tachometer-alt"></i> Performance Dashboard</h2>
                    <div class="date-range">
                        <select id="periodSelect" onchange="loadDashboardData()">
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month" selected>This Month</option>
                            <option value="quarter">This Quarter</option>
                        </select>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <div class="stat-value" id="totalOrders">0</div>
                        <div class="stat-label">Total Orders</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="stat-value" id="totalRevenue">KES 0</div>
                        <div class="stat-label">Total Revenue</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-value" id="totalCustomers">0</div>
                        <div class="stat-label">Customers</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-percentage"></i>
                        </div>
                        <div class="stat-value" id="conversionRate">0%</div>
                        <div class="stat-label">Conversion Rate</div>
                    </div>
                </div>

                <!-- Recent Orders -->
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-history"></i> Recent Orders</h3>
                        <button class="btn btn-sm" onclick="showSection('orders')">
                            View All <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table" id="recentOrdersTable">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody">
                                <tr>
                                    <td colspan="5" class="text-center">
                                        <div class="loading-spinner"></div>
                                        <p>Loading orders...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Top Products -->
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-star"></i> Popular Products</h3>
                        <button class="btn btn-sm" onclick="showSection('products')">
                            Browse All <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                    <div class="products-grid" id="topProductsGrid">
                        <div class="text-center" style="grid-column: 1 / -1; padding: 2rem;">
                            <div class="loading-spinner"></div>
                            <p>Loading products...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Products Section -->
            <div id="productsSection" class="content-section">
                <div class="section-header">
                    <h2><i class="fas fa-shopping-cart"></i> Product Ordering</h2>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="productSearch" placeholder="Search HOG Creations products..." onkeypress="if(event.key=='Enter') searchProducts()">
                        <button class="btn btn-sm" onclick="searchProducts()">Search</button>
                    </div>
                </div>
                
                <div class="products-filters">
                    <button class="filter-btn active" onclick="filterProducts('all')">All Products</button>
                    <button class="filter-btn" onclick="filterProducts('Clothing')">Clothing</button>
                    <button class="filter-btn" onclick="filterProducts('Accessories')">Accessories</button>
                    <button class="filter-btn" onclick="filterProducts('Footwear')">Footwear</button>
                    <div class="sort-dropdown">
                        <select id="sortProducts" onchange="sortProducts()">
                            <option value="name">Sort by Name</option>
                            <option value="price_low">Price: Low to High</option>
                            <option value="price_high">Price: High to Low</option>
                        </select>
                    </div>
                </div>
                
                <div class="products-grid" id="productsGrid">
                    <!-- Products loaded here -->
                </div>
                
                <!-- Order Modal -->
                <div id="orderModal" class="modal">
                    <div class="modal-content">
                        <span class="close-modal" onclick="closeModal()">&times;</span>
                        <h3>Place New Order</h3>
                        <form id="orderForm" onsubmit="placeOrder(event)">
                            <div class="form-group">
                                <label>Customer Name *</label>
                                <input type="text" id="customerName" required>
                            </div>
                            <div class="form-group">
                                <label>Phone Number *</label>
                                <input type="tel" id="customerPhone" required>
                            </div>
                            <div class="form-group">
                                <label>Delivery Address *</label>
                                <textarea id="deliveryAddress" rows="3" required></textarea>
                            </div>
                            <div class="form-group">
                                <label>Payment Method</label>
                                <select id="paymentMethod">
                                    <option value="cash">Cash on Delivery</option>
                                    <option value="mpesa">M-Pesa</option>
                                </select>
                            </div>
                            <div id="orderItems">
                                <h4>Order Items</h4>
                                <!-- Items added here -->
                            </div>
                            <div class="order-summary">
                                <h4>Total: <span id="orderTotal">KES 0</span></h4>
                            </div>
                            <button type="submit" class="btn btn-primary">Place Order</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Orders Section -->
            <div id="ordersSection" class="content-section">
                <div class="section-header">
                    <h2><i class="fas fa-clipboard-list"></i> Order Management</h2>
                    <button class="btn" onclick="showNewOrderForm()">
                        <i class="fas fa-plus"></i> New Order
                    </button>
                </div>
                
                <div class="orders-filters">
                    <button class="filter-btn active" onclick="filterOrders('all')">All Orders</button>
                    <button class="filter-btn" onclick="filterOrders('pending')">Pending</button>
                    <button class="filter-btn" onclick="filterOrders('processing')">Processing</button>
                    <button class="filter-btn" onclick="filterOrders('delivered')">Delivered</button>
                </div>
                
                <div class="orders-list" id="ordersList">
                    <div class="empty-state">
                        <i class="fas fa-clipboard-list"></i>
                        <h3>No Orders Yet</h3>
                        <p>Start by placing your first order from the Products section</p>
                        <button class="btn btn-primary" onclick="showSection('products')">
                            <i class="fas fa-shopping-cart"></i> Browse Products
                        </button>
                    </div>
                </div>
            </div>

            <!-- Resources Section -->
            <div id="resourcesSection" class="content-section">
                <div class="section-header">
                    <h2><i class="fas fa-file-alt"></i> Marketing Materials</h2>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search materials...">
                    </div>
                </div>
                
                <div class="resources-grid" id="materialsGrid">
                    <!-- Materials loaded here -->
                </div>
            </div>

            <!-- Updates Section -->
            <div id="updatesSection" class="content-section">
                <div class="section-header">
                    <h2><i class="fas fa-bullhorn"></i> Operational Updates</h2>
                </div>
                
                <div class="updates-list" id="updatesList">
                    <div class="empty-state">
                        <i class="fas fa-bullhorn"></i>
                        <h3>No Updates Available</h3>
                        <p>Check back later for operational updates and announcements</p>
                    </div>
                </div>
            </div>

            <!-- Support Section -->
            <div id="supportSection" class="content-section">
                <div class="card">
                    <h2><i class="fas fa-headset"></i> DSOG Support Center</h2>
                    <div class="support-grid">
                        <div class="support-card">
                            <i class="fas fa-phone"></i>
                            <h3>Phone Support</h3>
                            <p>Call us for immediate assistance</p>
                            <a href="tel:0733737983" class="btn btn-primary">Call: 0733 737 983</a>
                        </div>
                        <div class="support-card">
                            <i class="fab fa-whatsapp"></i>
                            <h3>WhatsApp Business</h3>
                            <p>Chat with our support team</p>
                            <a href="https://wa.me/254733737983" target="_blank" class="btn btn-success">
                                <i class="fab fa-whatsapp"></i> WhatsApp
                            </a>
                        </div>
                        <div class="support-card">
                            <i class="fas fa-envelope"></i>
                            <h3>Email Support</h3>
                            <p>Send detailed inquiries</p>
                            <a href="mailto:office.dsog@gmail.com" class="btn btn-outline">Email Us</a>
                        </div>
                        <div class="support-card">
                            <i class="fas fa-clock"></i>
                            <h3>Business Hours</h3>
                            <p>Monday - Saturday</p>
                            <p>8:00 AM - 7:00 PM</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="config.js"></script>
    <script>
        // Dashboard Application
        let currentProducts = [];
        let currentCategory = 'all';
        let currentUser = null;
        
        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
        });
        
        // Authentication check
        function checkAuthentication() {
            const user = localStorage.getItem('dsog_user');
            const token = localStorage.getItem('dsog_token');
            
            if (!user || !token) {
                // Show auth error and redirect
                document.getElementById('authError').style.display = 'block';
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 3000);
                return;
            }
            
            try {
                currentUser = JSON.parse(user);
                loadUserInfo();
                loadDashboardData();
                loadProducts();
                
                // Check for messages in URL
                const urlParams = new URLSearchParams(window.location.search);
                const message = urlParams.get('message');
                if (message) {
                    showMessage(decodeURIComponent(message), 'success');
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                logout();
            }
        }
        
        // Load user information
        function loadUserInfo() {
            if (!currentUser) return;
            
            document.getElementById('userName').textContent = currentUser.name || 'Franchise Owner';
            document.getElementById('userRole').textContent = currentUser.role || 'Franchise Owner';
            document.getElementById('welcomeName').textContent = currentUser.name?.split(' ')[0] || 'Partner';
            document.getElementById('franchiseCode').textContent = currentUser.franchise_code || 'FR-001';
            
            // Set avatar initials
            const initials = currentUser.name ? 
                currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase() : 
                'FO';
            document.getElementById('userAvatar').textContent = initials;
            
            console.log('User loaded:', currentUser);
        }
        
        // Load dashboard data
        async function loadDashboardData() {
            if (!currentUser || !currentUser.franchise_code) return;
            
            try {
                // Show loading state
                document.getElementById('totalOrders').innerHTML = '<div class="loading-spinner"></div>';
                document.getElementById('totalRevenue').innerHTML = '<div class="loading-spinner"></div>';
                document.getElementById('todayOrders').innerHTML = '<div class="loading-spinner"></div>';
                document.getElementById('monthRevenue').innerHTML = '<div class="loading-spinner"></div>';
                
                // Simulate API call (replace with actual API)
                setTimeout(() => {
                    // Mock data for demo
                    updateStats({
                        total_orders: 24,
                        total_revenue: 145800,
                        pending_orders: 3,
                        total_customers: 18,
                        conversion_rate: 65
                    });
                }, 1000);
                
            } catch (error) {
                console.error('Error loading stats:', error);
                showMessage('Failed to load dashboard data', 'error');
            }
        }
        
        // Update stats display
        function updateStats(stats) {
            document.getElementById('totalOrders').textContent = stats.total_orders || 0;
            document.getElementById('totalRevenue').textContent = 'KES ' + (stats.total_revenue || 0).toLocaleString();
            document.getElementById('todayOrders').textContent = stats.pending_orders || 0;
            document.getElementById('monthRevenue').textContent = 'KES ' + (stats.total_revenue || 0).toLocaleString();
            document.getElementById('totalCustomers').textContent = stats.total_customers || 0;
            document.getElementById('conversionRate').textContent = (stats.conversion_rate || 0) + '%';
            
            // Update pending orders badge
            const badge = document.getElementById('pendingOrdersBadge');
            if (badge && stats.pending_orders > 0) {
                badge.textContent = stats.pending_orders;
            }
            
            // Load recent orders
            loadRecentOrders();
        }
        
        // Load recent orders
        async function loadRecentOrders() {
            try {
                const tableBody = document.getElementById('ordersTableBody');
                if (!tableBody) return;
                
                // Mock data for demo
                const mockOrders = [
                    { id: 'ORD-001', customer: 'John Mwangi', date: '2024-01-15', amount: 12500, status: 'Delivered' },
                    { id: 'ORD-002', customer: 'Sarah Akinyi', date: '2024-01-14', amount: 8900, status: 'Processing' },
                    { id: 'ORD-003', customer: 'David Ochieng', date: '2024-01-13', amount: 15600, status: 'Pending' },
                    { id: 'ORD-004', customer: 'Mary Wanjiku', date: '2024-01-12', amount: 7400, status: 'Delivered' },
                    { id: 'ORD-005', customer: 'Peter Kamau', date: '2024-01-11', amount: 11200, status: 'Delivered' }
                ];
                
                tableBody.innerHTML = mockOrders.map(order => `
                    <tr>
                        <td><strong>${order.id}</strong></td>
                        <td>${order.customer}</td>
                        <td>${order.date}</td>
                        <td>KES ${order.amount.toLocaleString()}</td>
                        <td><span class="status-badge status-${order.status.toLowerCase()}">${order.status}</span></td>
                    </tr>
                `).join('');
                
            } catch (error) {
                console.error('Error loading orders:', error);
                document.getElementById('ordersTableBody').innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>Failed to load orders</p>
                        </td>
                    </tr>
                `;
            }
        }
        
        // Load products
        async function loadProducts() {
            const grid = document.getElementById('productsGrid');
            const topGrid = document.getElementById('topProductsGrid');
            
            if (!grid || !topGrid) return;
            
            // Show loading state
            grid.innerHTML = '<div class="loading-spinner"></div><p>Loading products...</p>';
            topGrid.innerHTML = '<div class="loading-spinner"></div><p>Loading popular products...</p>';
            
            try {
                // Mock product data for demo
                const mockProducts = [
                    { product_id: '1', name: 'Designer T-Shirt', category: 'Clothing', price: 2500, stock: 45, supplier: 'HOG Creations', description: 'Premium cotton t-shirt with unique design', image_url: 'https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?w=400&h=400&fit=crop' },
                    { product_id: '2', name: 'Leather Handbag', category: 'Accessories', price: 8500, stock: 12, supplier: 'HOG Creations', description: 'Genuine leather handbag with multiple compartments', image_url: 'https://images.unsplash.com/photo-1584917865442-de89df76afd3?w=400&h=400&fit=crop' },
                    { product_id: '3', name: 'Casual Sneakers', category: 'Footwear', price: 5200, stock: 28, supplier: 'HOG Creations', description: 'Comfortable casual sneakers for everyday wear', image_url: 'https://images.unsplash.com/photo-1542291026-7eec264c27ff?w-400&h=400&fit=crop' },
                    { product_id: '4', name: 'Denim Jacket', category: 'Clothing', price: 6800, stock: 18, supplier: 'HOG Creations', description: 'Classic denim jacket with modern fit', image_url: 'https://images.unsplash.com/photo-1551028719-00167b16eac5?w=400&h=400&fit=crop' },
                    { product_id: '5', name: 'Silver Necklace', category: 'Accessories', price: 3200, stock: 36, supplier: 'HOG Creations', description: 'Elegant silver necklace with pendant', image_url: 'https://images.unsplash.com/photo-1599643478518-a784e5dc4c8f?w=400&h=400&fit=crop' },
                    { product_id: '6', name: 'Formal Shoes', category: 'Footwear', price: 7500, stock: 15, supplier: 'HOG Creations', description: 'Professional formal shoes for business occasions', image_url: 'https://images.unsplash.com/photo-1611591437281-460bfbe1220a?w=400&h=400&fit=crop' }
                ];
                
                currentProducts = mockProducts;
                
                // Display all products
                displayProducts(mockProducts);
                
                // Display top products (first 4)
                displayTopProducts(mockProducts.slice(0, 4));
                
                // Update counts
                document.getElementById('availableProducts').textContent = mockProducts.length;
                document.getElementById('productsBadge').textContent = mockProducts.length;
                
            } catch (error) {
                console.error('Error loading products:', error);
                grid.innerHTML = '<div class="error">Failed to load products. Please try again later.</div>';
                topGrid.innerHTML = '<div class="error">Failed to load products</div>';
            }
        }
        
        // Display products in grid
        function displayProducts(products) {
            const grid = document.getElementById('productsGrid');
            if (!grid) return;
            
            if (products.length === 0) {
                grid.innerHTML = '<div class="empty-state"><i class="fas fa-box-open"></i><h3>No Products Found</h3><p>Try changing your search or filters</p></div>';
                return;
            }
            
            grid.innerHTML = products.map(product => `
                <div class="product-card">
                    <div class="product-image">
                        ${product.image_url ? 
                            `<img src="${product.image_url}" alt="${product.name}" onerror="this.src='https://via.placeholder.com/300x200?text=HOG+Product'">` : 
                            `<div class="product-icon"><i class="fas fa-tshirt"></i></div>`
                        }
                    </div>
                    <div class="product-info">
                        <h3 class="product-title">${product.name}</h3>
                        <div class="product-category">${product.category}</div>
                        <div class="product-price">KES ${product.price.toLocaleString()}</div>
                        <div class="product-supplier">${product.supplier || 'HOG Creations'}</div>
                        <div class="product-stock ${product.stock > 10 ? 'in-stock' : 'low-stock'}">
                            <i class="fas ${product.stock > 10 ? 'fa-check' : 'fa-exclamation-triangle'}"></i>
                            ${product.stock > 10 ? 'In Stock' : `${product.stock} left`}
                        </div>
                        <button class="btn btn-sm" onclick="addToOrder('${product.product_id}')">
                            <i class="fas fa-cart-plus"></i> Add to Order
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="viewProductDetails('${product.product_id}')">
                            <i class="fas fa-info-circle"></i> Details
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // Display top products
        function displayTopProducts(products) {
            const grid = document.getElementById('topProductsGrid');
            if (!grid) return;
            
            if (products.length === 0) {
                grid.innerHTML = '<div class="empty-state"><i class="fas fa-star"></i><h3>No Popular Products</h3><p>Products will appear here based on popularity</p></div>';
                return;
            }
            
            grid.innerHTML = products.map(product => `
                <div class="product-card">
                    <div class="product-image">
                        ${product.image_url ? 
                            `<img src="${product.image_url}" alt="${product.name}" onerror="this.src='https://via.placeholder.com/300x200?text=HOG+Product'">` : 
                            `<div class="product-icon"><i class="fas fa-tshirt"></i></div>`
                        }
                    </div>
                    <div class="product-info">
                        <h3 class="product-title">${product.name}</h3>
                        <div class="product-price">KES ${product.price.toLocaleString()}</div>
                        <div class="product-stock ${product.stock > 10 ? 'in-stock' : 'low-stock'}">
                            <i class="fas ${product.stock > 10 ? 'fa-check' : 'fa-exclamation-triangle'}"></i>
                            ${product.stock > 10 ? 'Available' : 'Low Stock'}
                        </div>
                        <button class="btn btn-sm" onclick="addToOrder('${product.product_id}')">
                            <i class="fas fa-cart-plus"></i> Order Now
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // Navigation functions
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active from all nav links
            document.querySelectorAll('.sidebar-nav a').forEach(link => {
                link.classList.remove('active');
            });
            
            // Show selected section
            const section = document.getElementById(sectionName + 'Section');
            if (section) {
                section.classList.add('active');
            }
            
            // Set active nav link
            const navLink = document.querySelector(`a[onclick*="${sectionName}"]`);
            if (navLink) {
                navLink.classList.add('active');
            }
            
            // Load section-specific data
            switch(sectionName) {
                case 'products':
                    loadProducts();
                    break;
                case 'orders':
                    loadUserOrders();
                    break;
                case 'resources':
                    loadMarketingMaterials();
                    break;
                case 'updates':
                    loadOperationalUpdates();
                    break;
            }
        }
        
        // Product filtering
        function filterProducts(category) {
            currentCategory = category;
            
            // Update filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            let filtered = currentProducts;
            if (category !== 'all') {
                filtered = currentProducts.filter(p => p.category === category);
            }
            
            displayProducts(filtered);
        }
        
        // Product search
        function searchProducts() {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            if (!searchTerm.trim()) {
                filterProducts(currentCategory);
                return;
            }
            
            const filtered = currentProducts.filter(product => 
                product.name.toLowerCase().includes(searchTerm) ||
                product.description.toLowerCase().includes(searchTerm) ||
                product.category.toLowerCase().includes(searchTerm)
            );
            
            displayProducts(filtered);
        }
        
        // Product sorting
        function sortProducts() {
            const sortBy = document.getElementById('sortProducts').value;
            let sorted = [...currentProducts];
            
            switch(sortBy) {
                case 'price_low':
                    sorted.sort((a, b) => a.price - b.price);
                    break;
                case 'price_high':
                    sorted.sort((a, b) => b.price - a.price);
                    break;
                case 'name':
                    sorted.sort((a, b) => a.name.localeCompare(b.name));
                    break;
            }
            
            displayProducts(sorted);
        }
        
        // Add to order
        function addToOrder(productId) {
            const product = currentProducts.find(p => p.product_id === productId);
            if (!product) return;
            
            showMessage(`Added ${product.name} to order cart`, 'success');
            // In a real app, you would add to a shopping cart array
        }
        
        // View product details
        function viewProductDetails(productId) {
            const product = currentProducts.find(p => p.product_id === productId);
            if (!product) return;
            
            const modal = document.getElementById('orderModal');
            const content = modal.querySelector('.modal-content');
            content.innerHTML = `
                <span class="close-modal" onclick="closeModal()">&times;</span>
                <h3>${product.name}</h3>
                <div class="product-details">
                    <div class="detail-row">
                        <strong>Category:</strong> ${product.category}
                    </div>
                    <div class="detail-row">
                        <strong>Price:</strong> KES ${product.price.toLocaleString()}
                    </div>
                    <div class="detail-row">
                        <strong>Supplier:</strong> ${product.supplier}
                    </div>
                    <div class="detail-row">
                        <strong>Stock:</strong> ${product.stock} units available
                    </div>
                    <div class="detail-row">
                        <strong>Description:</strong> ${product.description}
                    </div>
                </div>
                <button class="btn btn-primary" onclick="addToOrder('${productId}')">
                    <i class="fas fa-cart-plus"></i> Add to Order
                </button>
            `;
            modal.style.display = 'block';
        }
        
        // Show new order form
        function showNewOrderForm() {
            const modal = document.getElementById('orderModal');
            modal.style.display = 'block';
            showSection('products');
        }
        
        // Close modal
        function closeModal() {
            document.getElementById('orderModal').style.display = 'none';
        }
        
        // Place order
        async function placeOrder(event) {
            event.preventDefault();
            
            const orderData = {
                customerName: document.getElementById('customerName').value,
                customerPhone: document.getElementById('customerPhone').value,
                deliveryAddress: document.getElementById('deliveryAddress').value,
                paymentMethod: document.getElementById('paymentMethod').value,
                franchiseCode: currentUser?.franchise_code || 'FR-001'
            };
            
            try {
                showMessage('Placing order...', 'info');
                
                // Simulate API call
                setTimeout(() => {
                    showMessage('Order placed successfully!', 'success');
                    closeModal();
                    
                    // Reset form
                    document.getElementById('orderForm').reset();
                    
                    // Show orders section
                    showSection('orders');
                }, 1500);
                
            } catch (error) {
                showMessage('Failed to place order. Please try again.', 'error');
            }
        }
        
        // Load user orders
        async function loadUserOrders() {
            // Implement your orders loading logic here
        }
        
        // Load marketing materials
        async function loadMarketingMaterials() {
            // Implement your materials loading logic here
        }
        
        // Load operational updates
        async function loadOperationalUpdates() {
            // Implement your updates loading logic here
        }
        
        // Filter orders
        function filterOrders(status) {
            // Implement your order filtering logic here
        }
        
        // Show message
        function showMessage(text, type) {
            // Remove any existing messages
            const existingMessages = document.querySelectorAll('.message');
            existingMessages.forEach(msg => msg.remove());
            
            // Create message element
            const message = document.createElement('div');
            message.className = `message message-${type}`;
            message.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 
                                  type === 'error' ? 'exclamation-triangle' : 
                                  type === 'warning' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${text}</span>
                <button onclick="this.parentElement.remove()" class="close-btn">&times;</button>
            `;
            
            // Add to top of main content
            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                mainContent.insertBefore(message, mainContent.firstChild);
            } else {
                document.body.appendChild(message);
            }
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (message.parentElement) {
                    message.remove();
                }
            }, 5000);
        }
        
        // Logout function
        function logout() {
            // If user logged in with Google, revoke token
            const authMethod = localStorage.getItem('auth_method');
            if (authMethod === 'google' && window.google) {
                window.google.accounts.id.disableAutoSelect();
                window.google.accounts.id.revoke(localStorage.getItem('dsog_token'), done => {
                    console.log('Google session revoked');
                });
            }
            
            // Clear all local storage
            localStorage.removeItem('dsog_user');
            localStorage.removeItem('dsog_token');
            localStorage.removeItem('auth_method');
            localStorage.removeItem('dsog_cart');
            
            // Redirect to login page
            window.location.href = 'index.html';
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('orderModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        };
        
        // Add to global window object for HTML onclick handlers
        window.showSection = showSection;
        window.filterProducts = filterProducts;
        window.searchProducts = searchProducts;
        window.sortProducts = sortProducts;
        window.addToOrder = addToOrder;
        window.viewProductDetails = viewProductDetails;
        window.showNewOrderForm = showNewOrderForm;
        window.closeModal = closeModal;
        window.placeOrder = placeOrder;
        window.filterOrders = filterOrders;
        window.logout = logout;
    </script>
</body>
</html>
